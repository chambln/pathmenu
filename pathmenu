#!/usr/bin/env rc

fn main {

    fn ls {
        printf %s\n . ..
        builtin ls -F $*
    }

    fn pwd {
        realpath --relative-base=$DIR_INITIAL `{builtin pwd}
    }

    fn iter {
        if (~ $1 ()) {
            exit 1
        } else if (~ $1 .) {
            realpath $^1
        } else if (test -d $^1 && cd $^1) {
            shift
            $0 `{ls | dmenu} $*
        } else {
            realpath $^1
        }
    }

    for (arg in (. $*)) {
        if (test -d $^arg) {
            DIR_INITIAL = $^arg
        } else {
            switch ($^arg) {
                case -^(A d)
                    ARGS_LS = ($ARGS_LS $^arg)
                case -a
                    ARGS_LS = ($ARGS_LS -A)
                case *
                    ARGS_DMENU = ($ARGS_DMENU $^arg)
            }
        }
    }
    fn dmenu { builtin dmenu -p `pwd $ARGS_DMENU $* }
    iter `{ realpath $^DIR_INITIAL }

}

ifs=$nl
main $*
