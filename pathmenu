#!/bin/sh

dmenu='dmenu -p "$PWD"'
ls='/bin/ls -p'

die() {
    printf "$(basename "$0"): %s\n" "$@" 1>&2
    exit 1
}

iter() {
    for sel in $(eval "$cmd"); do (
        if [ "$sel" = ./ ]; then
            printf '%s\n' "$PWD"
        elif [ -d "$sel" ] && cd "$sel"; then
            iter
        else
            printf '%s\n' "$PWD/$sel"
        fi
    ) done
}

while :; do
    case "$1" in
    -d)
        dirs_only=true
        shift
	;;
    -a)
        ls="$ls -A"
        shift
        ;;
    -r|-t|-1)
        ls="$ls $1"
        shift
        ;;
    -b|-f|-i|-v)
        dmenu="$dmenu $1"
        shift
        ;;
    -h|--help|-\?)
        printf '%s\n' 'Usage: pathmenu [OPTION]... [DIRECTORY]...'
        exit
        ;;
    --)
        shift
        break
        ;;
    --*)
        die "No such option ‘$1’."
        ;;
    -l|-m|-p|-fn|-nb|-nf|-sb|-sf|-w)
        dmenu="$dmenu $1 \"$2\""
        shift 2
        ;;
    -*)
        dmenu="$dmenu $1"
        shift
        ;;
    *)
        break
        ;;
    esac
done

if [ "$dirs_only" = true ]; then
    cmd="( printf '%s/\n' .. . ; stest -d \$( $ls ) ) | $dmenu"
else
    cmd="( printf '%s/\n' .. . ; $ls ) | $dmenu"
fi

set -f; IFS='
'
for i in "${@:-.}"; do
    ( cd "$i" && iter )
done
